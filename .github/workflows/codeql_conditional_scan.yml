#1) HEADER & TRIGGER
name: "Codeql on Push & PR / Conditional Scan"

on:
  push:
    branches: [ "custom_queries" ]
  pull_request:
    branches: [ "custom_queries" ]

#2) CONFIGURAZIONE JOBS
jobs:
  analyze:
    name: Analyze Java - Conditional
    runs-on: ubuntu-latest

#3) PERMESSI - DEFINISCE COSA PUO' FARE IL WORKFLOW NEL REPOSITORY
    permissions:
      security-events: write # Per scrivere risultati di sicurezza
      packages: read # Per scaricare query pack CodeQL
      actions: read # Per leggere altri workflow
      contents: read # Per leggere il codice del repo

#4) CHECKOUT
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necessario per rilevare i file modificati

#5) RILEVAMENTO FILE MODIFICATI
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          **/*.java
          **/*.xml
          **/*.properties

#6) SETUP JAVA - CONDIZIONALE
    - name: Setup Java
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'

#7) INITIALIZE CODEQL - CONDIZIONALE
    - name: Initialize CodeQL
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: github/codeql-action/init@v3
      with:
        languages: java-kotlin
        build-mode: none

#8) BUILD MANUALE ELIMINATA

#9) ANALISI CODEQL - CONDIZIONALE
    - name: Perform CodeQL Analysis
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:java-kotlin"

#10) SUMMARY
    - name: Analysis Summary
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "WebGoat CodeQL analysis completed"
        echo "Files analyzed: ${{ steps.changed-files.outputs.all_changed_files }}"
        echo "Language: java-kotlin"
        
    - name: No Changes Summary
      if: steps.changed-files.outputs.any_changed == 'false'
      run: |
        echo "No Java/XML/Properties files changed"
        echo "‚è≠CodeQL analysis skipped for performance"
